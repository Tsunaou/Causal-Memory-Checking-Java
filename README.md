# Causal-Memory-Checking-Java

In this project, we have fully implemented the "Bad Pattern" based causal consistency checking algorithms proposed in [On verifying causal consistency@POPL'17](https://dl.acm.org/doi/10.1145/3009837.3009888) by Bouajjani et al. in Java. Users can check any history against three well-known causal consistency variants including CC, CM and CCv as long as the history are given in some specific format. We take this project to handle the `history.edn` generated by our Jepsen project [mongodb]([Tsunaou/mongodb at causal-checking (github.com)](https://github.com/Tsunaou/mongodb/tree/causal-checking)).

This project is also a part of the experiments of our paper named [Checking Causal Consistency of MongoDB](https://dl.acm.org/doi/10.1145/3457913.3457928) which has been accepted by *The 12th Asia-Pacific Symposium on Internetware* (***Internetware***). The presentation video can be found in [bilibili](https://www.bilibili.com/video/BV1dK4y197FS?share_source=copy_web).

## Requirement

- Java 8
- Maven

This project is managed by maven and all dependencies can be found in pom.xml.

## Getting Started

We provide `Causal-Memory-Checking-Java-jar-with-dependencies.jar` in `./target` and users can check history by this jar file. Here we give an example for running this.

### Parameters

- args[0]: concurrency
- args[1]: url of history
- args[2]: type(CC,CM,CCv,CMv)

### Example

Here are soma sample history in `src/main/resources`, take `paper_hisotry_a.edn` for example.

```edn
{:type :ok, :f :write, :value [x 1], :process 0, :time 0, :position 0, :link nil, :index 0}
{:type :ok, :f :read, :value [x 2], :process 0, :time 1, :position 1, :link nil, :index 1}
{:type :ok, :f :write, :value [x 2], :process 1, :time 2, :position 2, :link nil, :index 2}
{:type :ok, :f :read, :value [x 1], :process 1, :time 3, :position 3, :link nil, :index 3}
```

This history is taken from Figure 2(a) in [On verifying causal consistency@POPL'17](https://dl.acm.org/doi/10.1145/3009837.3009888). This history is CM but not CCv.

- There are 2 processes, so the concurrency is 2
- Suppose the url of `paper_history_a.edn` is `<url-history>`
- We want to check the satisfaction of CC, CM and CCv, so we choose CMv as input

```bash
./target/Causal-Memory-Checking-Java-jar-with-dependencies.jar 2 <url-history> CMv
```

The output will be

```bash
Reading history in D:\Education\Programs\Java\Causal-Memory-Checking-Java\src\main\resources\adhoc\paper_history_a.edn
Starting Checking Differentiated
:type :ok, :f :write, :value [x 1], :process 0, :time 0, :position 0, :link nil, :index 0, :realIndex 0
:type :ok, :f :read, :value [x 2], :process 0, :time 1, :position 1, :link nil, :index 1, :realIndex 1
:type :ok, :f :write, :value [x 2], :process 1, :time 2, :position 2, :link nil, :index 2, :realIndex 2
:type :ok, :f :read, :value [x 1], :process 1, :time 3, :position 3, :link nil, :index 3, :realIndex 3
LastIndex is 3
2021-11-05 22:28:16 Calculating PO
2021-11-05 22:28:16 Calculating RF
2021-11-05 22:28:16 Calculating CO
2021-11-05 22:28:16 Starting Check Causal Memory
2021-11-05 22:28:16 Checking CyclicCO
2021-11-05 22:28:16 Checking ThinAirRead
2021-11-05 22:28:16 Checking WriteCOInitRead
2021-11-05 22:28:16 Checking WriteCORead
2021-11-05 22:28:16 Checking Happened Before Order in Process 0
2021-11-05 22:28:16 Calculating HBo 1
w1 is 0, w2 is 2, r2 is 1  ADD HBO (0 2)
(0, 1), (0, 2), (2, 1), 
2021-11-05 22:28:16 Checking WriteHBInitRead 1
2021-11-05 22:28:16 Checking CyclicHB 1
2021-11-05 22:28:16 Checking Happened Before Order in Process 1
2021-11-05 22:28:16 Calculating HBo 3
w1 is 2, w2 is 0, r2 is 3  ADD HBO (2 0)
(0, 3), (2, 0), (2, 3), 
2021-11-05 22:28:16 Checking WriteHBInitRead 3
2021-11-05 22:28:16 Checking CyclicHB 3
Calculating CF
2021-11-05 22:28:16 Starting Check Causal Convergence
2021-11-05 22:28:16 Checking CyclicCF
Detected Cyclic!
Count: 0 Size:4
2021-11-05 22:28:16 Checking CMv outcome list
2021-11-05 22:28:16 Collecting ThinAirRead=false
2021-11-05 22:28:16 Collecting WriteCOInitRead=false
2021-11-05 22:28:16 Collecting CyclicHB=false
2021-11-05 22:28:16 Collecting CyclicCF=true
2021-11-05 22:28:16 Collecting WriteCORead=false
2021-11-05 22:28:16 Collecting CyclicCO=false
2021-11-05 22:28:16 Collecting WriteHBInitRead=false
2021-11-05 22:28:16 Cost 83 ms
2021-11-05 22:28:16 Inconsistency of CyclicCF

Process finished with exit code 0
```

#### Test Result Analysis

- We get `CyclicCF`  which is one of the bad patterns of CCv, so this history is not CCv.

- We do not get any bad patterns of CC and CM, so this history is both CC and CM.

